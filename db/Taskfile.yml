version: "3"

tasks:
  compile:
    desc: Generate Go code from SQL queries.
    sources:
      - sqlc.yaml
      - "./migrate/*.sql"
      - "./sql/*.sql"
    cmds:
      - sqlc generate

  compile:watch:
    desc: Watch for SQL query changes and recompile.
    cmds:
      - wgo -file '.sql$' sqlc generate

  drop:
    desc: Drop the database. Irreversible.
    dir: ./migrate
    ignore_error: true
    cmds:
      # TODO: database name; env check
      - psql postgres -c 'drop database verso_dev;'

  create:
    desc: Create the database.
    dir: ./migrate
    cmds:
      # TODO: database name
      - psql postgres -c 'create database verso_dev;'

  seed:
    desc: Seed the database with fixture data.
    dir: ..
    cmds:
      - go run main.go seed

  gen:
    desc: Generate a new migration.
    dir: ./migrate
    cmds:
      - goose create {{.CLI_ARGS}} sql

  migrate:
    desc: Migrate to the latest version.
    dir: ./migrate
    cmds:
      - goose up

  migrate:lint:
    desc: Lint migrations.
    dir: ./migrate
    cmds:
      - squawk *.sql

  rollback:
    desc: Roll back the last migration. Irreversible.
    dir: ./migrate
    cmds:
      - goose down

  redo:
    desc: Roll back and reapply the last migration.
    dir: ./migrate
    cmds:
      - goose redo

  reset:
    desc: Roll back and reapply all migrations.
    dir: ./migrate
    cmds:
      - task: drop
      - task: create
      - task: migrate
      - task: compile
      - task: seed

  status:
    desc: Show migration status.
    dir: ./migrate
    cmds:
      - goose status
